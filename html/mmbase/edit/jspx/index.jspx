<html
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:fn="http://java.sun.com/jsp/jstl/functions"
    xmlns:jsp="http://java.sun.com/JSP/Page"
    xmlns:mm="http://www.mmbase.org/mmbase-taglib-2.0">

  <jsp:output doctype-root-element="html"
              doctype-public="-//W3C//DTD XHTML 1.0 Strict//EN"
              doctype-system="http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"/>

  <!-- 
       Produces a search-tool, and the search result with links to create and change MMBase nodes.
       $Id: index.jspx,v 1.9 2006-04-27 17:18:42 michiel Exp $
  -->
  <jsp:directive.page session="true" buffer="200kb" />

  <mm:include page="head.jspx" />
  <body>
    <mm:content type="application/xhtml+xml" language="client" expires="0" postprocessor="none">
      <mm:cloud rank="basic user">
        <mm:import externid="nodemanager">object</mm:import>

        <form id="searchform" action="." method="post">
          <table class="search" summary="Search form">
            <thead>
              <tr>
                <th colspan="2">
                  <a href="javascript:document.getElementById('searchform').submit();" class="search">
                    <span class="navigate">
                      <input type="submit"  name="ok" value="ok" />
                    </span>
                  </a>
                  <mm:link referids="nodemanager" page="create.jspx">
                    <a href="${_}" class="create"><span class="navigate">create</span></a>
                  </mm:link>
                  <select name="nodemanager" onchange="this.form.submit();">
                    <mm:listnodes type="typedef" comparator="NATURAL">
                      <mm:hasnodemanager name="${_node.name}">
                        <c:choose>
                          <c:when test="${nodemanager eq _node.name}">
                            <option value="${_node.name}" selected="selected"><mm:nodeinfo type="gui" /></option>
                          </c:when>
                          <c:otherwise>
                            <option value="${_node.name}" ><mm:nodeinfo type="gui" /></option>
                          </c:otherwise>
                        </c:choose>
                      </mm:hasnodemanager>
                    </mm:listnodes>
                  </select>
                </th>
              </tr>
            </thead>
            <tbody>
              <mm:fieldlist nodetype="$nodemanager" type="search">
                <tr>
                  <td><mm:fieldinfo type="guiname" /></td>
                  <td><mm:fieldinfo type="searchinput" /></td>
                </tr>
              </mm:fieldlist>
            </tbody>
          </table>
        </form>

        <table id="searchresult" summary="Search results for ${nodemanager}"
>
          <mm:import id="pagesize">50</mm:import>
          <mm:import externid="offset">0</mm:import>

          <mm:listnodescontainer type="$nodemanager">
            <mm:import externid="sortfields">number</mm:import>
            <mm:import externid="sortdirections">down</mm:import>
            <mm:sortorder field="$sortfields" direction="$sortdirections" />

            <mm:link id="base" page="." referids="nodemanager">
              <mm:fieldlist nodetype="$nodemanager" type="search">
                <mm:fieldinfo type="reusesearchinput" />
                <mm:fieldinfo type="usesearchinput" />
              </mm:fieldlist>
            </mm:link>

            <mm:size id="size" write="false" />

            <mm:maxnumber value="$pagesize" />
            <mm:offset    value="$offset" />


            <thead>
              <tr class="paging">
                <th>${offset} - ${offset + pagesize lt size ? offset + pagesize : size} / ${size}</th>
                <th colspan="100">
                  <mm:import id="paging">
                    <mm:previousbatches max="10">
                      <mm:first><mm:isgreaterthan value="0">...</mm:isgreaterthan></mm:first>
                      <mm:link referids="_@offset" referid="base">
                        <a href="${_}"><mm:index /></a>
                      </mm:link>
                      <jsp:text>, </jsp:text>
                    </mm:previousbatches>
                    <span class="currentpage"><mm:index /></span>
                    <mm:nextbatches max="10">
                      <jsp:text>, </jsp:text>
                      <mm:link referids="_@offset" referid="base">
                        <a href="${_}"><mm:index /></a>
                      </mm:link>
                      <mm:last><mm:islessthan value="${size - pagesize}">...</mm:islessthan></mm:last>
                    </mm:nextbatches>
                  </mm:import>
                  <mm:write referid="paging" escape="none" />
                </th>
              </tr>

              <tr class="head">
                <th>#</th>
                <mm:fieldlist nodetype="$nodemanager" type="list">
                  <th><mm:fieldinfo type="guiname" /></th>
                </mm:fieldlist>
              </tr>
            </thead>

            <tfoot>
              <tr class="paging">
                <th /><th colspan="100"><mm:write referid="paging" escape="none" /></th>
              </tr>
            </tfoot>

            <mm:listnodes id="result" />
            <c:if test="${fn:length(result) gt 0}">
              <tbody>
                <mm:listnodes referid="result">
                  <mm:index id="index" write="false" />
                  <mm:link referids="_node@node,nodemanager" page="change.jspx">
                    <tr onclick="document.location.href='${_}';"
                        class="${index % 2 == 0 ? 'even' : 'odd'}">
                      <td><a href="${_}"><mm:field name="number" /></a><jsp:text> </jsp:text><mm:nodeinfo type="gui" /></td>
                      <mm:fieldlist type="list" nodetype="$nodemanager">
                        <td><mm:fieldinfo type="guivalue" /></td>
                      </mm:fieldlist>
                    </tr>
                  </mm:link>
                </mm:listnodes>
              </tbody>
            </c:if>
          </mm:listnodescontainer>
        </table>
      </mm:cloud>
    </mm:content>
  </body>
</html>
