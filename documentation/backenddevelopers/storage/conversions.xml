<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN"
"http://www.oasis-open.org/docbook/xml/4.0/docbookx.dtd">
<article class="specification">
	<articleinfo>
		<title>Storage Conversions</title>
		<date>2005-05-24</date>
		<edition>$Id: conversions.xml,v 1.2 2005-06-10 11:32:43 michiel Exp $</edition>

		<authorgroup>
			<!-- one or more authors -->
			<author>
				<firstname>Michiel</firstname>
				<surname>Meeuwissen</surname>
			</author>
		</authorgroup>


		<abstract>
			<para>Storage conversion</para>
		</abstract>

		<legalnotice>
			<para>This software is OSI Certified Open Source Software. OSI Certified
			is a certification mark of the Open Source Initiative.</para>
			<para>The license (Mozilla version 1.0) can be read at the MMBase site.
			See <ulink url="http://www.mmbase.org/license">http://www.mmbase.org/license</ulink></para>
		</legalnotice>
	</articleinfo>

	<section id="introduction">
		<title>Introduction</title>
		<para>
      HOWTO on database-conversions
    </para>
  </section>

	<section id="blobstofile">
		<title>Converting blobs to files</title>
		<para>
      Use the tool in mmbase/admin/tools. TODO: more info, details, how-to..
    </para>
	</section>
  <section id="filestoblobs">
    <title>Convert files to blobs</title>
    <para>
      Can this be done?
    </para>
  </section>
  <section id="datetime">
    <title>Introducing 'DATETIME'</title>
    <para>
      In MMBase 1.7 datetime were stored as 'LONG' or 'INTEGER' fields with 'guitype'
      'eventtimes'. In 1.8 also 'DATETIME' is supported for database type. So if you have an
      existing installation, you may want to convert these fields.      
    </para>
    <para>
      It is simple to change the builder XML's, but the database will need a manual conversion.
    </para>
    <section id="datetime_psql">
      <title>PostgreSQL</title>
      <para>
        To transform a column named 'begin' in the builder 'content' to DATETIME you can do the
        following. This is tested on Postgresql 7.2. It should also work on higher version, though
        it could be simplified there. For example you may want to drop the old column then (not
        supported in psql 7.2).
        <programlisting>
          alter table mm_content rename begin to begin_;
          alter table mm_content add column begin timestamp;
          update mm_content set begin = 'epoch';
          update mm_content set begin  = begin + CAST(begin_||'s' AS interval);
          # alter table drop column begin_; (not supported in 7.2)
        </programlisting>
      </para>
      <para>
        Because the column cannot be dropped MMBase will issue a warning on it's startup:
        <programlisting>
          13:36:55,810 8095kB WAR storage.implementation.database.DatabaseStorageManager - VERIFY: Column 'begin_' for builder 'categories' in Storage but not defined!
        </programlisting>
        This can safely be ignored, until the column can be dropped in some way. IIRC even newer
        version of postgresql cannot really drop the column, only hide it. In that case you can
        probably actually remove it by reimporting a database dump.
      </para>
      <para>
        This works too (converting a column 'broadcasttime'):
        <programlisting>
          create table mm_programs2 (broadcasttime timestamp) inherits  mm_texts;
          insert into mm_programs2 (number,otype,owner,begin,m_end,visible,title,body,broadcasttime,lastmodifiedby,lastmodified) select number,otype,owner,begin,m_end,visible,title,body,  '1970-01-01'::date + CAST(broadcasttime ||'s' AS interval),lastmodifiedby,lastmodified from mm_programs;
          alter table mm_programs rename to mm_programs_orig; alter table mm_programs2 rename to mm_programs;          
        </programlisting>
        And then check if everthing is ok, and you can drop mm_programs_orig;
      </para>
    </section>
    <section id="datetime_mysql">
      <title>MySql</title>
      <para>
        TODO
      </para>
    </section>
    <section id="datetime_hsql">
      <title>HSQL</title>
      <para>
        Probably simply start from scratch...
      </para>
    </section>
  </section>

</article>
