<?xml version="1.0"?>
<!DOCTYPE wizard-schema PUBLIC "-//MMBase/DTD editwizard 1.0//EN" "http://www.mmbase.org/dtd/wizard-schema_1_0.dtd">
<wizard-schema id="empty">
    <title>Leerblok Editor</title>

    <action type="create">
        <object type="learnblocks">
        </object>
    </action>
    <action type="load">
        <relation destination="learnobjects" role="posrel" />
        <relation destination="mmevents" role="related" />
        <relation destination="metadata" role="related">
          <object type="metadata">
           <relation destination="metalangstring" role="posrel">
              <object type="metalangstring">
                <field name="number"/>
                <field name="language"/>
                <field name="value"/>
              </object>
            </relation>
           <relation destination="metadate" role="posrel">
              <object type="metadate">
                <field name="number"/>
                <field name="value"/>
              </object>
            </relation>
           <relation destination="metavocabulary" role="posrel">
              <object type="metavocabulary">
                <field name="number"/>
                <field name="value"/>
              </object>
            </relation>
            <relation destination="metadefinition" role="related">
              <object type="metadefinition">
                <relation destination="metavocabulary" role="related"/>
              </object>
            </relation>
            </object>
        </relation>
    </action>

    <action type="delete" />

    <steps>
        <step form-schema="step1" />
        <step form-schema="step2" />
    </steps>

    <form-schema id="step1">
        <title>Leerblok invoeren</title>
        <field name="name" >
            <prompt>Naam</prompt>
        </field>

        <field name="intro" ftype="html" dtminlength="0">
            <prompt>Tekst</prompt>
        </field>

        <!--
           We want to list learnobjects, but there are objects that extend learnobject that we want to show.
           if you do the following:
             <list destination="learnobjects" role="posrel">
           then you can't show the 'tests' or 'pages' items, since the editwizard engine will simply discard
           them since they don't have the 'learnobject' type; it generates:
             <list destination="learnobjects" fdatapath="relation[@role='posrel' and object/@type='learnobjects']" ...

           Workaround: use fdatapath. 
             fortunately the only posrel we have is to learnobjects, so this is a bit of an ugly hack
        
           Note: the 'wizard.xsl' file depends on the title being "Bijbehorende leerobjecten" in order to
           select the correct JSP for finding learnobjects. DO NOT CHANGE THIS TITLE!
        -->
        <list minoccurs="0" maxoccurs="*" ordertype="number" orderby="field[@name='pos']" fdatapath="relation[@role='posrel']">
            <title>Bijbehorende leerobjecten</title>
            <item>
                <field fdatapath="object/field[@name='name']" ftype="data">
                    <prompt>Naam</prompt>
                    <description>Naam van het leerobject</description>
                </field>
            	<field fdatapath="field[@name='pos']" ftype="data">
                  <prompt>Positie</prompt>
                  <description>Positie van het leerobject in de lijst</description>
                </field>
            </item>

            <action type="create">
                <relation role="posrel" destinationtype="learnobjects">
                  <field name="pos">{sum(//relation[@role='posrel' and @lastitem='true']/field[@name='pos'])+{$pos}}</field>
                </relation>
            </action>

            <command name="startwizard" inline="true" wizardname="learnblocks" objectnumber="new">
              <prompt>Nieuw leerblok 
              </prompt>
            </command>

            <command name="startwizard" inline="true" wizardname="pages" objectnumber="new">
              <prompt>Nieuwe pagina</prompt>
            </command>

            <command name="startwizard" inline="true" wizardname="flashpages" objectnumber="new">
              <prompt>Nieuwe flash pagina</prompt>
            </command>

            <command name="startwizard" inline="true" wizardname="tests" objectnumber="new">
              <prompt>Nieuwe toets</prompt>
            </command>
            <command name="search" nodepath="learnobjects" fields="name" age="7" orderby="number" directions="down" >
                <prompt>Zoeken naar leerobjecten</prompt>
                <search-filter>
                    <name>Naam bevat</name>
                    <search-fields>name</search-fields>
                </search-filter>
           </command>
        </list>


        <!-- we need a new list because there can be only one search command per list -->
        <list minoccurs="0" maxoccurs="*" ordertype="number" orderby="field[@name='pos']" fdatapath="relation[@role='posrel']">
            <title>Zoeken op tekenreeks</title>
            <item displaytype="none"></item>
 
            <action type="create">
                <relation role="posrel" destinationtype="learnobjects">
                  <field name="pos">{sum(//relation[@role='posrel' and @lastitem='true']/field[@name='pos'])+{$pos}}</field>
                </relation>
            </action>


             <command name="search" nodepath="metalangstring,metadata,learnobjects" fields="learnobjects.name,metalangstring.value" age="7" orderby="learnobjects.number" directions="down" >
                <prompt>Zoeken naar leerobjecten op metadata</prompt>
                <search-filter>
                    <name>Metadata tekenreeks bevat</name>
                    <search-fields>metalangstring.value</search-fields>
                </search-filter>
           </command>           
        </list>

        <!-- we need a new list because there can be only one search command per list -->
        <list minoccurs="0" maxoccurs="*" ordertype="number" orderby="field[@name='pos']" fdatapath="relation[@role='posrel']">
            <title>Zoeken op vocabulair</title>
            <item displaytype="none"></item>
 
            <action type="create">
                <relation role="posrel" destinationtype="learnobjects">
                  <field name="pos">{sum(//relation[@role='posrel' and @lastitem='true']/field[@name='pos'])+{$pos}}</field>
                </relation>
            </action>


             <command name="search" nodepath="metavocabulary,metadata,learnobjects" fields="learnobjects.name,metavocabulary.value" age="7" orderby="learnobjects.number" directions="down" >
                <prompt>Zoeken naar leerobjecten op metadata</prompt>
                <search-filter>
                    <name>Metadata vocabulair bevat</name>
                    <search-fields>metavocabulary.value</search-fields>
                </search-filter>
           </command>
           
        </list>



        <list role="related" extends="list/online.xml" />
    </form-schema>

    <form-schema id="step2">
        <title>Metadata invoeren</title>
        <list extends="list/metadatalangstring.xml"/>
        <list extends="list/metadatadate.xml"/>
        <list extends="list/metadatavocabulary.xml"/>
    </form-schema>

</wizard-schema>
