<project name="didactor2" default="build" basedir=".">
  <!-- We need the 'foreach' and 'if' tasks, therefore we use ant-contrib -->
  <taskdef resource="net/sf/antcontrib/antcontrib.properties">
    <classpath>
      <pathelement location="lib/ant-contrib-1.0b1.jar"/>
    </classpath>
  </taskdef>

  <property file="build.properties"/>

  <target name="create.dirs">
    <mkdir dir="${build.dir}" />
    <mkdir dir="${build.dir}/classes" />
    <mkdir dir="${build.dir}/webapp" />
    <mkdir dir="${build.dir}/webapp/${includepath}" />
    <mkdir dir="${build.dir}/webapp/WEB-INF" />
    <mkdir dir="${build.dir}/webapp/WEB-INF/config" />
    <mkdir dir="${build.dir}/webapp/WEB-INF/lib" />
  </target>
  
  <target name="build">
    <echo message="Building components: ${components}" />
    <delete file="${build.dir}/webapp/WEB-INF/taglib.tld" />
    <delete file="${build.dir}/webapp/WEB-INF/web.xml" />
    <foreach list="${components}" target="build.component" inheritall="true" param="component" />
    <foreach list="${providers}" target="build.provider" inheritall="true" param="provider" />
    <replace file="${build.dir}/webapp/WEB-INF/web.xml"
             token="$${filemanagement.data.directory}"
             value="${filemanagement.data.directory}"/>
    <replace file="${build.dir}/webapp/WEB-INF/web.xml"
             token="$${internalUrl}"
             value="${internalUrl}"/>

    <replace file="${build.dir}/webapp/WEB-INF/web.xml"
             token="$${filemanagement.data.url}"
             value="${filemanagement.data.url}"/>
  </target>

  <target name="clean">
    <delete dir="${build.dir}" />
  </target>

  <target name="webapp" depends="clean,create.dirs,build,config,copy_builders">

  </target>

  <target name="config">
    <ant antfile="configure.xml" target="config"/>
  </target>

  <target name="build.provider">
    <echo message="Building provider ${provider}" />

    <!-- copy templates -->
    <if>
     <available file="src/core/templates/${provider}" type="dir" />
     <then>
        <echo message="Copying templates for ${provider}" />
        <copy todir="${build.dir}/webapp/${provider}">
            <fileset dir="src/core/templates/${provider}">
             <include name="**"/>
             <exclude name="**/CVS"/>
             <exclude name="templates/**"/>
            </fileset>
        </copy>
      </then>
      <else>
        <echo message="WARNING! provider ${provider} does not have any templates in src/core/templates/${provider}!!!"/>
      </else>
    </if>
  </target>


  <target name="build.component">
    <echo message="Building component ${component}" />

    <!-- copy templates -->
    <if>
     <available file="src/${component}/templates" type="dir" />
     <then>
        <if>
         <equals arg1="${component}" arg2="core"/>
         <then>
           <copy todir="${build.dir}/webapp">
            <fileset dir="src/${component}/templates">
             <include name="*.jsp"/>
             <include name="admin/**"/>
             <include name="cockpit/**"/>
             <include name="components/**"/>
             <include name="css/**"/>
             <include name="editwizards/**"/>
             <include name="gfx/**"/>    
             <include name="help/**"/>
             <include name="mmeditors/**"/>
             <include name="shared/**"/>
             <include name="users/**"/>
             <include name="metadata/**"/>            
             <include name="${component}/**"/>
             <exclude name="**/CVS"/>
             <exclude name="templates/**"/>
            </fileset>
           </copy>
        </then>
         <else>
            <copy todir="${build.dir}/webapp">
            <fileset dir="src/${component}/templates">
             <include name="${component}/**"/>
             <include name="editwizards/**"/>
             <exclude name="**/CVS"/>
             <exclude name="templates/**"/>
            </fileset>
           </copy>       
         </else>
        </if>
       </then>
    </if>

    <!-- copy webinf -->
    <if>
      <available file="src/${component}/webinf" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp/WEB-INF">
          <fileset dir="src/${component}/webinf">
            <include name="**"/>
            <exclude name="**/CVS"/>
            <exclude name="**/taglib-extra.tld" />
          </fileset>
        </copy>
      </then>
    </if>


    <!-- add extra tag definitions -->
    <if>
      <available file="src/${component}/webinf/taglib-extra.tld" type="file" />
      <then>
        <loadfile property="rp1"
                  srcFile="src/${component}/webinf/taglib-extra.tld"/>
        <property name="replacevalue" value="--&gt;${rp1}&lt;!-- EXTRATAGDEF" />
        <replace file="${build.dir}/webapp/WEB-INF/taglib.tld"
                 token="EXTRATAGDEF"
                 value="${replacevalue}" />
      </then>
    </if>

    <!-- add extra tag inclusions in web.xml -->
    <if>
      <available file="src/${component}/webinf/web-extra.xml" type="file" />
      <then>
        <loadfile property="rp2"
                  srcFile="src/${component}/webinf/web-extra.xml"/>
        <property name="replacevalue2" value="--&gt;${rp2}&lt;!-- EXTRATAGLIB" />
        <replace file="${build.dir}/webapp/WEB-INF/web.xml"
                 token="EXTRATAGLIB"
                 value="${replacevalue2}" />
      </then>
    </if>

    <!-- copy configuration files -->
    <if>
      <available file="src/${component}/config" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp/WEB-INF/config">
          <fileset dir="src/${component}/config">
            <include name="**"/>
            <exclude name="**/CVS"/>
          </fileset>
        </copy>
      </then>
    </if>

    <!-- copy external libs -->
    <if>
      <available file="src/${component}/lib" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp/WEB-INF/lib">
          <fileset dir="src/${component}/lib">
            <include name="**"/>
            <exclude name="**/CVS"/>
          </fileset>
        </copy>
      </then>
    </if>

    <!-- build java sources and create a jar file -->
    <if>
      <available file="src/${component}/java" type="dir"/>
      <then>
        <path id="classpath">
          <fileset dir="lib/">
            <include name="*.jar" />
          </fileset>
          <fileset dir="${build.dir}/webapp/WEB-INF/lib">
            <include name="*.jar" />
          </fileset>
          <fileset dir="src/${component}/lib">
            <include name="*.jar" />
          </fileset>
        </path>
        <mkdir dir="${build.dir}/classes/${component}" />

        <copy todir="${build.dir}/classes/${component}">
          <fileset dir="src/${component}/java">
	        <include name="**/*.properties" />
            <exclude name="**/*.java"/>
          </fileset>
        </copy>

        <javac srcdir="src/${component}/java"
               destdir="${build.dir}/classes/${component}"
               deprecation="on"
               debug="yes"
               classpathref="classpath" />
        <jar jarfile="${build.dir}/webapp/WEB-INF/lib//didactor-${component}.jar"
             includes="**"
             basedir="${build.dir}/classes/${component}" />
      </then>
    </if>
  </target>

  <target name="javadoc">
    <mkdir dir="${build.dir}/javadoc" />
    <javadoc destdir="${build.dir}/javadoc">
      <classpath>
        <fileset dir="${build.dir}/webapp/WEB-INF/lib">
          <include name="*.jar" />
        </fileset>
        <fileset dir="lib/">
          <include name="*.jar" />
        </fileset>
      </classpath>
      <fileset dir="src">
        <include name="**/*.java" />
      </fileset>
      <group title="Components" packages="nl.didactor.component.*" />
    </javadoc>
  </target>
  
  <!-- Begin van Antlets gedeelte -->
  
  <taskdef resource="org/krysalis/antworks/importer/antlib.xml"
         classpath="${user.home}/.antworks/lib/antworks-importer.jar"/>


    <property name="importer.repository" 
      value="http://www.kolov.net/antworks/"/>

    
    <importer name="init-0.1" href="${importer.repository}"/>
    <importer name="tomcat5-0.1" href="${importer.repository}"/>
    <importer name="webapp-0.1" href="${importer.repository}"/>
    
    <property name="tomcat5-antlet.deploy.archive" value= "${build.dir}/didactor.war"/>
	<target name="war" depends="webapp"> 
	  <jar destfile="${build.dir}/${war.name}.war" 
	       basedir="${build.dir}/webapp"
	  />
	</target>
	
	<target name="_deploy" depends="war, tomcat5.deploy"/>
	<target name="_redeploy" depends="war, tomcat5.redeploy"/>	
  
   <!-- copy all (MMBase) builders
	from: "./WEB-INF/config/applications/**/builders/*.xml"
	to:   "./WEB-INF/config/builders/" 
	-->
	<target name="copy_builders">
       <if>
         <available file="${build.dir}/webapp/WEB-INF/config/applications" type="dir" />
         <then>
           <copy todir="${build.dir}/webapp/WEB-INF/config/builders" flatten="yes">
             <fileset dir="${build.dir}/webapp/WEB-INF/config/applications">
               <include name="**/builders/*.xml"/>
             </fileset>
           </copy>
         </then>
       </if>
	</target>

</project>
