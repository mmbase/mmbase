<%--
The inputfield for a new webmail message, the message is send by dowrite.jsp
--%>
<%@taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@taglib uri="http://www.mmbase.org/mmbase-taglib-1.0" prefix="mm" %>
<%@taglib uri="http://www.didactor.nl/ditaglib_1.0" prefix="di" %>
<fmt:bundle basename="nl.didactor.component.email.EmailMessageBundle">
<mm:content postprocessor="none"><%-- no reducespace: it messes with the textarea --%>
<mm:cloud loginpage="/login.jsp" jspvar="cloud">

<%@include file="/shared/setImports.jsp"%>


<mm:treeinclude page="/cockpit/cockpit_header.jsp" objectlist="$includePath" referids="$referids">
  <mm:param name="extraheader">
    <title>Send mail</title>
  </mm:param>
</mm:treeinclude>


<div class="rows">

<div class="navigationbar">
  <div class="titlebar">
    <img src="<mm:treefile write="true" page="/gfx/icon_email.gif" objectlist="$includePath" />" width="25" height="13" border="0" alt="e-mail" /> E-mail
  </div>
</div>

<div class="folders">
  <div class="folderHeader">

  </div>
  <div class="folderBody">

  <mm:import externid="email"/>

  <mm:import id="reply" externid="reply"/>
  <mm:present referid="reply">
    <mm:import id="loadOld"><mm:write referid="reply"/></mm:import>
  </mm:present>

  <mm:import id="replyAll" externid="replyAll"/>
  <mm:present referid="replyAll">
    <mm:import id="loadOld"><mm:write referid="replyAll"/></mm:import>
  </mm:present>

  <mm:import id="forward" externid="forward"/>
  <mm:present referid="forward">
    <mm:import id="loadOld"><mm:write referid="forward"/></mm:import>
  </mm:present>

  <mm:present referid="loadOld">
    <mm:node referid="loadOld">
      <mm:present referid="reply">
        <mm:import id="to"><mm:field name="html(from)"/></mm:import>
        <mm:import id="subject">Re:<mm:field name="html(subject)"/></mm:import>
      </mm:present>
      <mm:present referid="replyAll">
        <mm:import id="to"><mm:field name="html(from)"/></mm:import>
        <mm:import id="cc"><mm:field name="html(cc)"/></mm:import>
        <mm:import id="subject">Re:<mm:field name="html(subject)"/></mm:import>
      </mm:present>
      <mm:present referid="forward">
        <mm:import id="subject">Fw:<mm:field name="html(subject)"/></mm:import>
      </mm:present>

      <mm:field name="body" jspvar="body" vartype="String" write="false">
      <mm:field name="headers" jspvar="headers" vartype="String" write="false">
        <%
	    
	    body = headers.replaceAll("(^|[\n])","$1> ") + "\n>" +
		    body.replaceAll("(^|[\n])","\n> ");
        %>
	<mm:import id="body"><%=body%></mm:import> 
      </mm:field>
      </mm:field>
    </mm:node>
  </mm:present>


  <script>
    function submitForm() {
      var hasTo = false;
      for (var i in document.forms['webmailForm']['to'][0].options) {
	  if (document.forms['webmailForm']['to'][0].options[i].selected) {
	      hasTo = true;
	      break;
	  }
      }
      if((!hasTo)  && document.forms['webmailForm']['to'][1].value.length == 0) {
        alert('<fmt:message key="TOEMPTY" />');
        return;
      }

      if(document.forms['webmailForm']['subject'].value.length == 0) {
		alert('<fmt:message key="SUBJECTEMPTY" />');
        return;
      }

      if(document.forms['webmailForm']['body'].value.length == 0) {
        alert('<fmt:message key="BODYEMPTY" />');
        return;
      }

      for(var count = 1; count <= 10; count++) {
        var filename = document.forms['webmailForm']['att' + count + '_handle'].value;
        var lastSlash = filename.lastIndexOf('/');
        var lastBackslash = filename.lastIndexOf('\\');
        var clipStart = (lastSlash > lastBackslash) ? lastSlash : lastBackslash;

        if(clipStart > -1)
          filename = filename.substring(clipStart+1);
        document.forms['webmailForm']['attachmentName'+count].value = filename;
      }

      document.forms['webmailForm'].submit()
    }


    function changeAtt(id) {
      if(id < 10) {
        document.getElementById('att'+(id+1)).style.height = '22px';
        document.getElementById('att'+(id+1)).style.visibility = 'visible';
      }
    }
  </script>

  <mm:treeinclude write="true" page="/email/cockpit/menuitem.jsp" objectlist="$includePath">
    <mm:param name="icon">write message</mm:param>
    <mm:param name="text"><fmt:message key="WRITEMESSAGE" /></mm:param>
  </mm:treeinclude>

  </div>
</div>

<div class="mainContent">
  <div class="contentHeader">

  </div>
  <div class="contentBodywit">

  <form action="<mm:treefile write="true" page="/email/write/dowrite.jsp" objectlist="$includePath">
                <mm:notpresent referid="course"><mm:param name="provider" value="$provider"/></mm:notpresent>
                </mm:treefile>" method="post" enctype="multipart/form-data" name="webmailForm">
    <table class="font">
            <tr>
              <td><fmt:message key="TO" /> :&nbsp;</td>
              <td>
               <select name="to" multiple="multiple">
	        <mm:list nodes="$user" path="people,addressbooks,contacts" orderby="contacts.firstname,contacts.lastname" fields="contacts.number" distinct="true">
		    <option value="&quot;<mm:field name="contacts.firstname"/> <mm:field name="contacts.lastname"/>&quot; &lt;<mm:field name="contacts.email"/>&gt;">&quot;<mm:field name="contacts.firstname"/> <mm:field name="contacts.lastname"/>&quot; &lt;<mm:field name="contacts.email"/>&gt;</option>
		</mm:list>
		<mm:list nodes="$user" path="people1,classes,people2" orderby="people2.firstname,people2.lastname" constraints="people2.number != $user" fields="people2.number" distinct="true">
		    <option value="&quot;<mm:field name="ontacts.firstname"/> <mm:field name="people2.lastname"/>&quot; &lt;<mm:field name="people2.email"/>&gt;">&quot;<mm:field name="people2.firstname"/> <mm:field name="people2.lastname"/>&quot; &lt;<mm:field name="people2.email"/>&gt;</option>
		</mm:list>
						    
 
		</select><br/>
	
	      <input type="text" class="formInput" name="to"
                <mm:present referid="email">
                  value="<mm:write referid="email"/>"
                </mm:present>
                <mm:present referid="to">
                  value="<mm:write referid="to"/>"
                </mm:present>
              ></td>
              </tr>
 
            </tr>
            <tr>
              <td><fmt:message key="CC" /> :&nbsp;</td>
              <td>
                <select name="cc" multiple="multiple">
	        <mm:list nodes="$user" path="people,addressbooks,contacts" orderby="contacts.firstname,contacts.lastname" fields="contacts.number" distinct="true">
		    <option value="&quot;<mm:field name="contacts.firstname"/> <mm:field name="contacts.lastname"/>&quot; &lt;<mm:field name="contacts.email"/>&gt;">&quot;<mm:field name="contacts.firstname"/> <mm:field name="contacts.lastname"/>&quot; &lt;<mm:field name="contacts.email"/>&gt;</option>
		</mm:list>
		<mm:list nodes="$user" path="people1,classes,people2" orderby="people2.firstname,people2.lastname" constraints="people2.number != $user" fields="people2.number" distinct="true">
		    <option value="&quot;<mm:field name="ontacts.firstname"/> <mm:field name="people2.lastname"/>&quot; &lt;<mm:field name="people2.email"/>&gt;">&quot;<mm:field name="people2.firstname"/> <mm:field name="people2.lastname"/>&quot; &lt;<mm:field name="people2.email"/>&gt;</option>
		</mm:list>
						    
 
		</select><br/>
	      
	      <input type="text" class="formInput" name="cc"
                <mm:present referid="cc">
                  value="<mm:write referid="cc"/>"
                </mm:present>
              ></td>
	      </tr>
           <tr>
              <td><fmt:message key="SUBJECT" /> :&nbsp;</td>
              <td><input type="text" class="formInput" name="subject"
                <mm:present referid="subject">
                  value="<mm:write referid="subject"/>"
                </mm:present>
              ></td>
            </tr>
            <tr>
              <td>
              </td>
              <td>
                <br>
                <textarea name="body"
                ><mm:present referid="body"><mm:write referid="body"/></mm:present></textarea>
                <br>
              </td>
            </tr>
            <tr>
              <td><fmt:message key="ATTACHMENTS" /> :&nbsp;</td>
              <td>
                <%for(int count = 1; count <= 10; count++) {%>
                  <div id="att<%=count%>"
                          <%if(count > 1) {%>style="visibility:hidden;height:1px;overflow:hidden;"<%}%>
                          <%if(count == 1) {%>style="height:22px;overflow:hidden;"<%}%>
                          >
                    <input type="hidden" name="attachmentName<%=count%>">
                    <input type="file" class="formInput" name="att<%=count%>_handle" onclick="changeAtt(<%=count%>)">
                  </div>
                <%}%>
              </td>
            </tr>
            <tr>
              <td>
              	<div class="button1">
				<a href="javascript:submitForm();">send</a>
				</div>
              </td>
              <td>
				<div class="button1">
				<a href="javascript:history.go(-1);">back</a>
				</div>
              </td>
            </tr>
    </table>
  </form>

  </div>
</div>
</div>

<mm:treeinclude page="/cockpit/cockpit_footer.jsp" objectlist="$includePath" referids="$referids" />
</mm:cloud>
</mm:content>
</fmt:bundle>
