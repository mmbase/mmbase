<project name="didactor2" default="build" basedir=".">
  <!-- We need the 'foreach' and 'if' tasks, therefore we use ant-contrib -->
  <taskdef resource="net/sf/antcontrib/antcontrib.properties">
    <classpath>
      <pathelement location="lib/ant-contrib-1.0b1.jar"/>
    </classpath>
  </taskdef>

  <property file="build.properties"/>

  <target name="create.dirs">
    <mkdir dir="${build.dir}" />
    <mkdir dir="${build.dir}/classes" />
    <mkdir dir="${build.dir}/webapp" />
    <mkdir dir="${build.dir}/webapp/WEB-INF" />
    <mkdir dir="${build.dir}/webapp/WEB-INF/config" />
    <mkdir dir="${build.dir}/webapp/WEB-INF/lib" />
  </target>

  <target name="build">
    <echo message="Building components: ${components}" />
    <delete file="${build.dir}/webapp/WEB-INF/taglib.tld" />
    <delete file="${build.dir}/webapp/WEB-INF/web.xml" />
    <foreach list="${components}" target="build.component" inheritall="true" param="component" />
    <foreach list="${security_components}" target="build.security.component" inheritall="true" param="component" />
    <foreach list="${providers}" target="build.provider" inheritall="true" param="provider" />
    <replace file="${build.dir}/webapp/WEB-INF/web.xml"
             token="$${filemanagement.data.directory}"
             value="${filemanagement.data.directory}"/>
    <replace file="${build.dir}/webapp/WEB-INF/web.xml"
             token="$${internalUrl}"
             value="${internalUrl}"/>

    <replace file="${build.dir}/webapp/WEB-INF/web.xml"
             token="$${filemanagement.data.url}"
             value="${filemanagement.data.url}"/>

    <replace file="${build.dir}/webapp/WEB-INF/web.xml"
             token="$${emailsenderdomain}"
             value="${emailsenderdomain}"/>

     <ant antfile="configure.xml" target="config"/>
     <if>
       <available file="${build.dir}/webapp/WEB-INF/config/applications" type="dir" />
       <then>
         <copy todir="${build.dir}/webapp/WEB-INF/config/builders" flatten="yes">
           <fileset dir="${build.dir}/webapp/WEB-INF/config/applications">
             <include name="**/builders/*.xml"/>
           </fileset>
         </copy>
       </then>
     </if>
  </target>

  <target name="compileonly">
    <echo message="Only compiling all classes" />
    <foreach list="${components}" target="compile.component" inheritall="true" param="component" />
    <foreach list="${security_components}" target="compile.security.component" inheritall="true" param="component" />
  </target>

  <target name="clean">
    <delete dir="${build.dir}" />
  </target>

  <target name="webapp" depends="clean,create.dirs,build,config">

  </target>

  <target name="config">
    <ant antfile="configure.xml" target="config"/>
  </target>

  <target name="build.provider">
    <echo message="Building provider ${provider}" />

    <!-- copy templates -->
    <if>
      <available file="src/core/templates/${provider}" type="dir" />
      <then>
        <echo message="Copying templates from src/core/templates/${provider}" />
        <echo message="Warning: putting provider templates in /src/core/templates is deprecated, consider using /providers/${provider}/templates instead"/>
        <copy todir="${build.dir}/webapp/${provider}" overwrite="true">
          <fileset dir="src/core/templates/${provider}">
            <include name="**"/>
            <exclude name="**/CVS"/>
            <exclude name="templates/**"/>
          </fileset>
        </copy>
      </then>
      <else>
        <if>
          <available file="providers/${provider}/templates" type="dir" />
          <then>
            <echo message="Copying templates from providers/${provider}/templates" />
            <copy todir="${build.dir}/webapp/${provider}" overwrite="true">
              <fileset dir="providers/${provider}/templates">
                <include name="**"/>
                <exclude name="**/CVS"/>
              </fileset>
            </copy>
          </then>
          <else>
            <echo message="WARNING! provider ${provider} does not have any templates in /src/core/templates/${provider} or /providers/${provider}/templates"/>
          </else>
        </if>
      </else>
    </if>

    <!-- copy templates -->
    <if>
     <available file="providers/${provider}/webinf" type="dir" />
     <then>
      <echo message="Copying WEB-INF files from providers/${provider}/webinf" />
        <copy todir="${build.dir}/webapp/WEB-INF" overwrite="true">
          <fileset dir="providers/${provider}/webinf">
            <include name="**"/>
            <exclude name="**/CVS"/>
          </fileset>
        </copy>
      </then>
    </if>
  </target>

  <target name="compile.component">
    <echo message="Compiling component ${component}" />
    <!-- copy external libs -->
    <if>
      <available file="src/${component}/lib" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp/WEB-INF/lib">
          <fileset dir="src/${component}/lib">
            <include name="**"/>
            <exclude name="**/CVS"/>
          </fileset>
        </copy>
      </then>
    </if>

    <!-- build java sources and create a jar file -->
    <if>
      <available file="src/${component}/java" type="dir"/>
      <then>
        <path id="classpath">
          <fileset dir="lib/">
            <include name="*.jar" />
          </fileset>
          <fileset dir="${build.dir}/webapp/WEB-INF/lib">
            <include name="*.jar" />
          </fileset>
          <fileset dir="src/${component}/lib">
            <include name="*.jar" />
          </fileset>
        </path>
        <mkdir dir="${build.dir}/classes/${component}" />

        <copy todir="${build.dir}/classes/${component}">
          <fileset dir="src/${component}/java">
           <include name="**/*.properties" />
            <exclude name="**/*.java"/>
          </fileset>
        </copy>

        <javac srcdir="src/${component}/java"
               destdir="${build.dir}/classes/${component}"
               deprecation="on"
               debug="yes"
               classpathref="classpath" />
        <jar jarfile="${build.dir}/webapp/WEB-INF/lib//didactor-${component}.jar"
             includes="**"
             basedir="${build.dir}/classes/${component}" />
      </then>
    </if>
    <if>
      <available file="src/${component}/build.xml" type="file" />
      <then>
        <echo message="running src/${component}/build.xml"/>
        <ant antfile="src/${component}/build.xml" target="build"/>
      </then>
    </if>
  </target>





  <target name="compile.security.component">
    <echo message="Compiling security component ${component}" />
    <!-- copy external libs -->
    <if>
      <available file="src/security/${component}/lib" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp/WEB-INF/lib">
          <fileset dir="src/security/${component}/lib">
            <include name="**"/>
            <exclude name="**/CVS"/>
          </fileset>
        </copy>
      </then>
    </if>

    <!-- build java sources and create a jar file -->
    <if>
      <available file="src/security/${component}/java" type="dir"/>
      <then>
        <path id="classpath">
          <fileset dir="lib/">
            <include name="*.jar" />
          </fileset>
          <fileset dir="${build.dir}/webapp/WEB-INF/lib">
            <include name="*.jar" />
          </fileset>
          <fileset dir="src/security/${component}/lib">
            <include name="*.jar" />
          </fileset>
        </path>
        <mkdir dir="${build.dir}/classes/${component}" />

        <copy todir="${build.dir}/classes/${component}">
          <fileset dir="src/security/${component}/java">
           <include name="**/*.properties" />
            <exclude name="**/*.java"/>
          </fileset>
        </copy>

        <javac srcdir="src/security/${component}/java"
               destdir="${build.dir}/classes/${component}"
               deprecation="on"
               debug="yes"
               classpathref="classpath" />
        <jar jarfile="${build.dir}/webapp/WEB-INF/lib//didactor-security-${component}.jar"
             includes="**"
             basedir="${build.dir}/classes/${component}" />
      </then>
    </if>
    <if>
      <available file="src/security/${component}/build.xml" type="file" />
      <then>
        <echo message="running src/security/${component}/build.xml"/>
        <ant antfile="src/security/${component}/build.xml" target="build"/>
      </then>
    </if>
  </target>





  <target name="build.component" depends="compile.component">
    <echo message="Building component ${component}" />

    <!-- copy templates -->
    <if>
     <available file="src/${component}/templates" type="dir" />
     <then>
        <if>
         <equals arg1="${component}" arg2="core"/>
         <then>
           <copy todir="${build.dir}/webapp">
            <fileset dir="src/${component}/templates">
             <include name="*.jsp"/>
             <include name="admin/**"/>
             <include name="cockpit/**"/>
             <include name="components/**"/>
             <include name="css/**"/>
             <include name="editwizards/**"/>
             <include name="gfx/**"/>
             <include name="help/**"/>
             <include name="mmbase/**"/>
             <include name="mmeditors/**"/>
             <include name="shared/**"/>
             <include name="users/**"/>
             <include name="metadata/**"/>
             <include name="migrate/**"/>
             <include name="${component}/**"/>
             <include name="classes/**"/>
             <exclude name="**/CVS"/>
             <exclude name="templates/**"/>
            </fileset>
           </copy>
        </then>
         <else>
            <copy todir="${build.dir}/webapp" overwrite="true">
            <fileset dir="src/${component}/templates">
             <include name="**"/>
             <exclude name="**/CVS"/>
             <exclude name="templates/**"/>
             <exclude name="editwizards/**/extra_*.xml"/>
            </fileset>
           </copy>
         </else>
        </if>
       </then>
    </if>

    <!-- copy webinf -->
    <if>
      <available file="src/${component}/webinf" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp/WEB-INF">
          <fileset dir="src/${component}/webinf">
            <include name="**"/>
            <exclude name="**/CVS"/>
            <exclude name="**/taglib-extra.tld" />
          </fileset>
        </copy>
      </then>
    </if>


    <!-- add extra tag definitions -->
    <if>
      <available file="src/${component}/webinf/taglib-extra.tld" type="file" />
      <then>
        <loadfile property="rp1"
                  srcFile="src/${component}/webinf/taglib-extra.tld"/>
        <property name="replacevalue" value="--&gt;${rp1}&lt;!-- EXTRATAGDEF" />
        <replace file="${build.dir}/webapp/WEB-INF/taglib.tld"
                 token="EXTRATAGDEF"
                 value="${replacevalue}" />
      </then>
    </if>

    <!-- add extra tag inclusions in web.xml -->
    <if>
      <available file="src/${component}/webinf/web-extra.xml" type="file" />
      <then>
        <loadfile property="rp2"
                  srcFile="src/${component}/webinf/web-extra.xml"/>
        <property name="replacevalue2" value="--&gt;${rp2}&lt;!-- EXTRATAGLIB" />
        <replace file="${build.dir}/webapp/WEB-INF/web.xml"
                 token="EXTRATAGLIB"
                 value="${replacevalue2}" />
      </then>
    </if>

    <!-- copy configuration files -->
    <if>
      <available file="src/${component}/config" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp/WEB-INF/config">
          <fileset dir="src/${component}/config">
            <include name="**"/>
            <exclude name="**/CVS"/>
          </fileset>
        </copy>
      </then>
    </if>


    <!-- merge editwizard definitions -->
    <if>
      <available file="src/${component}/templates/editwizards/data/config/" />
      <then>
        <foreach target="mergewizards" param="file">
          <path>
            <fileset dir="src/${component}/templates/editwizards/data/config/">
              <include name="**/extra_*.xml" />
            </fileset>
          </path>
        </foreach>
      </then>
    </if>

  </target>




  <target name="build.security.component" depends="compile.security.component">
    <echo message="Building security component ${component}" />

    <!-- copy templates -->
    <if>
      <available file="src/security/${component}/templates" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp" overwrite="true">
          <fileset dir="src/security/${component}/templates">
            <include name="**"/>
            <exclude name="**/CVS"/>
            <exclude name="templates/**"/>
            <exclude name="editwizards/**/extra_*.xml"/>
          </fileset>
        </copy>
      </then>
    </if>

    <!-- copy webinf -->
    <if>
      <available file="src/security/${component}/webinf" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp/WEB-INF">
          <fileset dir="src/security/${component}/webinf">
            <include name="**"/>
            <exclude name="**/CVS"/>
            <exclude name="**/taglib-extra.tld" />
          </fileset>
        </copy>
      </then>
    </if>


    <!-- add extra tag definitions -->
    <if>
      <available file="src/security/${component}/webinf/taglib-extra.tld" type="file" />
      <then>
        <loadfile property="rp1"
                  srcFile="src/security/${component}/webinf/taglib-extra.tld"/>
        <property name="replacevalue" value="--&gt;${rp1}&lt;!-- EXTRATAGDEF" />
        <replace file="${build.dir}/webapp/WEB-INF/taglib.tld"
                 token="EXTRATAGDEF"
                 value="${replacevalue}" />
      </then>
    </if>

    <!-- add extra tag inclusions in web.xml -->
    <if>
      <available file="src/security/${component}/webinf/web-extra.xml" type="file" />
      <then>
        <loadfile property="rp2"
                  srcFile="src/security/${component}/webinf/web-extra.xml"/>
        <property name="replacevalue2" value="--&gt;${rp2}&lt;!-- EXTRATAGLIB" />
        <replace file="${build.dir}/webapp/WEB-INF/web.xml"
                 token="EXTRATAGLIB"
                 value="${replacevalue2}" />
      </then>
    </if>

    <!-- copy configuration files -->
    <if>
      <available file="src/security/${component}/config" type="dir" />
      <then>
        <copy todir="${build.dir}/webapp/WEB-INF/config">
          <fileset dir="src/security/${component}/config">
            <include name="**"/>
            <exclude name="**/CVS"/>
          </fileset>
        </copy>
      </then>
    </if>


    <!-- merge editwizard definitions -->
    <if>
      <available file="src/security/${component}/templates/editwizards/data/config/" />
      <then>
        <foreach target="mergewizards" param="file">
          <path>
            <fileset dir="src/security/${component}/templates/editwizards/data/config/">
              <include name="**/extra_*.xml" />
            </fileset>
          </path>
        </foreach>
      </then>
    </if>

  </target>








  <target name="mergewizards">
    <echo>MergeWizards: ${file}</echo>
    <pathconvert property="cleaned_filename" dirsep="${file.separator}" pathsep="${path.separator}">
      <path path="${file}" />
      <mapper>
        <globmapper from="${basedir}/src/${component}/templates/editwizards/data/config/*" to="*" handledirsep="yes" />
      </mapper>
    </pathconvert>
    <pathconvert property="destfile" dirsep="${file.separator}" pathsep="${path.separator}">
      <path path="${build.dir}/webapp/editwizards/data/config/${cleaned_filename}" />
    </pathconvert>
    <echo>Destfile: ${destfile}</echo>
    <if>
      <available file="${destfile}" />
      <then>
        <echo>Merging in extra wizards defs for ${component}: ${cleaned_filename}</echo>
        <concat destfile="${destfile}" append="true">
          <path path="${file}" />
        </concat>
      </then>
      <else>
        <echo>Copying extra wizards defs for ${component}: ${cleaned_filename}</echo>
        <copy file="${file}" tofile="${destfile}" />
      </else>
    </if>
  </target>


  <target name="javadoc">
    <mkdir dir="${build.dir}/javadoc" />
    <javadoc destdir="${build.dir}/javadoc">
      <classpath>
        <fileset dir="${build.dir}/webapp/WEB-INF/lib">
          <include name="*.jar" />
        </fileset>
        <fileset dir="lib/">
          <include name="*.jar" />
        </fileset>
      </classpath>
      <fileset dir="src">
        <include name="**/*.java" />
      </fileset>
      <group title="Components" packages="nl.didactor.component.*" />
    </javadoc>
  </target>

  <!-- Begin van Antlets gedeelte -->
  <!--
  <taskdef resource="org/krysalis/antworks/importer/antlib.xml"
         classpath="${user.home}/.antworks/lib/antworks-importer.jar"/>


    <property name="importer.repository"
      value="http://www.kolov.net/antworks/"/>


    <importer name="init-0.1" href="${importer.repository}"/>
    <importer name="tomcat5-0.1" href="${importer.repository}"/>
    <importer name="webapp-0.1" href="${importer.repository}"/>

    <property name="tomcat5-antlet.deploy.archive" value= "${build.dir}/didactor.war"/>
   -->
   <target name="war" depends="webapp">
     <tstamp />
     <jar destfile="${build.dir}/${war.name}${DSTAMP}_${TSTAMP}.war"
          basedir="${build.dir}/webapp"
     />
   </target>

   <!--
     If you want to precompile the webapplicationn, you need to use Tomcat5, and
     set the property 'tomcat.home' in your properties file
     Also, you might want to set:
       build.compiler=jikes
     because compilation with the classic/modern compilers takes a lot of time and memory.
    -->
   <target name="precompile" depends="webapp">
     <taskdef classname="org.apache.jasper.JspC" name="jasper2" >
       <classpath id="jspc.classpath">
         <pathelement location="${java.home}/../lib/tools.jar"/>
         <fileset dir="${tomcat.home}/server/lib">
           <include name="*.jar"/>
         </fileset>
         <fileset dir="${tomcat.home}/common/lib">
           <include name="*.jar"/>
         </fileset>
         <fileset dir="src/core/lib">
           <include name="*.jar"/>
         </fileset>
       </classpath>
     </taskdef>

     <jasper2
             validateXml="false"
             addWebXmlMappings="true"
             uriroot="${build.dir}/webapp"
             webXmlFragment="${build.dir}/webapp/WEB-INF/jsp.xml"
             outputDir="${build.dir}/jspjava" />

     <mkdir dir="${build.dir}/jspclasses" />
     <javac destdir="${build.dir}/jspclasses"
           optimize="off"
           debug="on" failonerror="false"
           srcdir="${build.dir}/jspjava"
           fork="true" memoryMaximumSize="512M">
      <classpath>
        <fileset dir="${build.dir}/webapp/WEB-INF/lib">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="${tomcat.home}/common/lib">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="${tomcat.home}/shared/lib">
          <include name="*.jar"/>
        </fileset>
      </classpath>
      <include name="**" />
    </javac>

    <jar jarfile="${build.dir}/webapp/WEB-INF/lib/didactor-jsp.jar"
         includes="**"
         basedir="${build.dir}/jspclasses" />
  </target>

  <target name="precompiledwar" depends="precompile,war" />

  <target name="srcdist">
    <mkdir dir="${build.dir}" />
    <delete file="${build.dir}/didactor-src.zip" quiet="true"/>
    <zip destfile="${build.dir}/didactor-src.zip"
         basedir=".">
      <includesfile name="sourcedistfiles.properties" />
      <include name="lib/**"/>
      <include name="*.xml" />
      <include name="README.txt" />
      <zipfileset dir="." includes="configure.properties.srcdist" fullpath="configure.properties" />
      <zipfileset dir="." includes="build.properties.srcdist" fullpath="build.properties" />
      <exclude name="**/CVS"/>
    </zip>
  </target>

</project>
